<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智慧衣物更換提醒系統</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f4f9;
    }
    .header {
        padding: 15px 20px;
        text-align: center;
        background-color: #f4f4f9;
    }
    .header h1 {
        margin: 0;
        color: #333;
        font-size: 24px;
    }
    .page-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 59px);
        box-sizing: border-box;
    }
    .top-panel {
        margin: 0 10px;
        padding: 15px 20px;
        background-color: #ffffff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-sizing: border-box;
        z-index: 10;
    }
    .main-content {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .button-group {
        display: flex;
        flex-direction: row;
        gap: 10px;
    }
    .button-group button {
        padding: 8px 18px;
        margin-bottom: 0;
        border: 1px solid #ccc;
        background-color: #fff;
        color: #333;
        cursor: pointer;
        border-radius: 20px;
        transition: all 0.3s ease;
        font-size: 15px;
        font-weight: normal;
    }
    .button-group button:hover {
        border-color: #007bff;
        color: #007bff;
    }
    #btn-all.active {
        background-color: #e0f7e0;
        border-color: #a5d6a7;
        color: #388e3c;
        font-weight: bold;
    }
    #btn-sweater.active {
        background-color: #d1ecf1;
        border-color: #74c0fc;
        color: #03539e;
        font-weight: bold;
    }
    #btn-uniform.active {
        background-color: #fce4ec;
        border-color: #f8bbd0;
        color: #c2185b;
        font-weight: bold;
    }
    #upload-section {
        margin-left: auto;
    }
    #file-input {
        display: none;
    }
    .upload-btn {
        display: block;
        text-align: center;
        padding: 8px 18px;
        border: 1px solid #6c757d;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        border-radius: 20px;
        transition: all 0.3s ease;
        font-size: 15px;
    }
    .upload-btn:hover {
        background-color: #6c757d;
        color: #fff;
    }
    .charts-wrapper {
        display: flex;
        gap: 20px;
        width: 100%;
        margin-bottom: 20px;
    }
    .chart-card {
        flex: 1;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: relative;
    }
    .chart-title {
        text-align: center;
        margin-top: 0;
        margin-bottom: 15px;
        color: #495057;
        font-size: 16px;
    }
    .chart-container {
        position: relative;
        height: 300px;
        cursor: pointer;
    }
    .btn-reset-filter {
        position: absolute;
        top: 15px;
        right: 15px;
        display: none;
        padding: 5px 10px;
        font-size: 12px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: background-color 0.3s;
        z-index: 5;
    }
    .btn-reset-filter:hover {
        background-color: #5a6268;
    }
    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .search-container {
        position: relative;
        display: flex;
        align-items: center;
    }
    #keyword-search {
        padding: 8px 30px 8px 15px;
        border-radius: 20px;
        border: 1px solid #ccc;
        font-size: 14px;
        width: 250px;
    }
    #clear-search-btn {
        position: absolute;
        right: 10px;
        cursor: pointer;
        display: none;
        color: #888;
        font-size: 20px;
        line-height: 1;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
    }
    th {
        background-color: #007bff;
        color: white;
    }
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    tr:hover {
        background-color: #e9ecef;
    }
    .overdue {
        color: red;
        font-weight: bold;
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>
<body>

<div class="header">
    <h1>衣物更換提醒系統</h1>
</div>

<div class="page-container">
    <div class="top-panel">
        <label><strong>選擇模式:</strong></label>
        <div class="button-group">
            <button id="btn-all" class="active">查看所有人狀態</button>
            <button id="btn-sweater">毛衣</button>
            <button id="btn-uniform">制服</button>
        </div>
        <div id="upload-section">
            <label for="file-input" class="upload-btn">上傳 Excel</label>
            <input type="file" id="file-input" accept=".xlsx, .xls, .csv">
        </div>
    </div>
    <div class="main-content">
        <div class="charts-wrapper">
            <div class="chart-card">
                 <button class="btn-reset-filter" id="btn-reset-bar">返回查看全部</button>
                <h3 class="chart-title" id="bar-chart-title">所有衣物狀態統計</h3>
                <div class="chart-container">
                    <canvas id="expiry-bar-chart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <button class="btn-reset-filter" id="btn-reset-pie">返回查看全部</button>
                <h3 class="chart-title" id="pie-chart-title">所有衣物狀態分佈</h3>
                <div class="chart-container">
                    <canvas id="days-pie-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="list-header">
            <h2 id="right-panel-title">所有人員衣物狀態總覽</h2>
            <div class="search-container">
                <input type="text" id="keyword-search" placeholder="搜尋姓名、員編、單位等...">
                <span id="clear-search-btn">&times;</span>
            </div>
        </div>
        <div id="output"></div>
    </div>
</div>

<script>
    // 註冊 Chart.js 數據標籤外掛
    Chart.register(ChartDataLabels);

    let excelData = [];
    let pieChart, barChart;
    let currentDataForTable = [];

    const rightPanelTitle = document.getElementById('right-panel-title');
    const allButtons = document.querySelectorAll('.button-group button');
    const pieChartTitle = document.getElementById('pie-chart-title');
    const barChartTitle = document.getElementById('bar-chart-title');
    const resetPieBtn = document.getElementById('btn-reset-pie');
    const resetBarBtn = document.getElementById('btn-reset-bar');
    const searchInput = document.getElementById('keyword-search');
    const clearSearchBtn = document.getElementById('clear-search-btn');

    function convertMinguoToAD(minguoDate) {
        if (!minguoDate || typeof minguoDate !== 'string') return null;
        const parts = minguoDate.split('.');
        if (parts.length !== 3) return null;
        try {
            const year = parseInt(parts[0], 10) + 1911;
            const month = parseInt(parts[1], 10) - 1;
            const day = parseInt(parts[2], 10);
            return new Date(year, month, day);
        } catch (e) { return null; }
    }

    document.getElementById('file-input').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: ["編號", "單位", "員編", "姓名", "職稱", "到職日", "衣服種類", "領取日期"],
                raw: false, range: 1
            });
            let processedData = [];
            let lastPerson = {};
            jsonData.forEach(row => {
                if (row["姓名"] && row["姓名"].trim() !== "") lastPerson = row;
                if (row["衣服種類"]) {
                     processedData.push({...lastPerson, "衣服種類": row["衣服種類"], "領取日期": row["領取日期"] || null});
                }
            });
            excelData = processedData;
            
            allButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-all').classList.add('active');
            displayAllData();
        };
        reader.readAsArrayBuffer(file);
    });

    allButtons.forEach(button => {
        button.addEventListener('click', function() {
            allButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const mode = this.id;
            if (mode === 'btn-all') {
                displayAllData();
            } else {
                filterAndDisplayData();
            }
        });
    });
    
    [resetPieBtn, resetBarBtn].forEach(btn => {
        btn.addEventListener('click', function() {
            renderTable(currentDataForTable);
            resetPieBtn.style.display = 'none';
            resetBarBtn.style.display = 'none';
        });
    });
    
    searchInput.addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        clearSearchBtn.style.display = keyword ? 'block' : 'none';
        
        const tableRows = document.querySelectorAll('#output table tbody tr');
        tableRows.forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(keyword) ? '' : 'none';
        });
    });

    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
    });
    
    function calculateDayDiff(row) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const pickupDate = convertMinguoToAD(row['領取日期']);
        let dayDiff = null;
        if (pickupDate) {
            const expiryDate = new Date(pickupDate.getTime());
            if (row['衣服種類'] === '制服') {
                expiryDate.setFullYear(expiryDate.getFullYear() + 2);
            } else if (row['衣服種類'] === '毛衣') {
                expiryDate.setFullYear(expiryDate.getFullYear() + 3);
            }
            const timeDiff = expiryDate.getTime() - today.getTime();
            dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        }
        return { ...row, dayDiff: dayDiff };
    }

    function displayAllData() {
        if (excelData.length === 0) {
            document.getElementById('output').innerHTML = '<p>請先上傳 Excel 檔案。</p>';
            return;
        };

        rightPanelTitle.textContent = '所有人員衣物狀態總覽';
        pieChartTitle.textContent = '所有衣物狀態分佈';
        barChartTitle.textContent = '所有衣物狀態統計';
        
        currentDataForTable = excelData.map(calculateDayDiff);
        
        updateAllModeCharts(currentDataForTable);
        renderTable(currentDataForTable, true);
        resetPieBtn.style.display = 'none';
        resetBarBtn.style.display = 'none';
    }

    function filterAndDisplayData() {
        if (excelData.length === 0) {
            document.getElementById('output').innerHTML = '<p>請先上傳 Excel 檔案。</p>';
            return;
        }

        rightPanelTitle.textContent = '應更換人員列表 (含已過期)';
        pieChartTitle.textContent = '提醒狀態分佈';
        barChartTitle.textContent = '提醒狀態統計';
        
        const activeButton = document.querySelector('.button-group .active');
        const selectedClothing = activeButton.id === 'btn-uniform' ? '制服' : '毛衣';
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const oneMonthFromNow = new Date();
        oneMonthFromNow.setDate(today.getDate() + 30);

        currentDataForTable = excelData
            .filter(row => row['衣服種類'] === selectedClothing && row['領取日期'])
            .map(calculateDayDiff)
            .filter(row => {
                const expiryDate = new Date();
                expiryDate.setHours(0,0,0,0);
                expiryDate.setDate(expiryDate.getDate() + row.dayDiff);
                return expiryDate <= oneMonthFromNow;
            });

        updateReminderCharts(currentDataForTable);
        renderTable(currentDataForTable);
        resetPieBtn.style.display = 'none';
        resetBarBtn.style.display = 'none';
    }

    function renderTable(data, isAllMode = false) {
        const outputDiv = document.getElementById('output');
        
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        
        data.sort((a, b) => {
            if (a.dayDiff === null) return 1;
            if (b.dayDiff === null) return -1;
            return a.dayDiff - b.dayDiff;
        });

        let tableHeader = isAllMode ? 
            '<th>編號</th><th>單位</th><th>員編</th><th>姓名</th><th>衣服種類</th><th>原領取日期</th><th>狀態</th>' :
            '<th>編號</th><th>單位</th><th>員編</th><th>姓名</th><th>職稱</th><th>原領取日期</th><th>狀態</th>';

        if (data.length > 0) {
            let table = `<table><thead><tr>${tableHeader}</tr></thead><tbody>`;
            data.forEach(row => {
                let statusText = '';
                let rowClass = '';
                if (row.dayDiff === null) {
                    statusText = '無領取日期';
                } else if (row.dayDiff < 0) {
                    statusText = `已過期 ${-row.dayDiff} 天`;
                    rowClass = 'overdue';
                } else if (row.dayDiff === 0) {
                    statusText = '今天到期';
                } else {
                    statusText = `尚餘 ${row.dayDiff} 天`;
                }
                let tableRowContent = isAllMode ?
                    `<td>${row['編號']||''}</td><td>${row['單位']||''}</td><td>${row['員編']||''}</td><td>${row['姓名']||''}</td><td>${row['衣服種類']||''}</td><td>${row['領取日期']||''}</td><td>${statusText}</td>` :
                    `<td>${row['編號']||''}</td><td>${row['單位']||''}</td><td>${row['員編']||''}</td><td>${row['姓名']||''}</td><td>${row['職稱']||''}</td><td>${row['領取日期']||''}</td><td>${statusText}</td>`;

                table += `<tr class="${rowClass}">${tableRowContent}</tr>`;
            });
            table += '</tbody></table>';
            outputDiv.innerHTML = table;
        } else {
            outputDiv.innerHTML = '<p>沒有符合條件的人員。</p>';
        }
    }
    
    function updateAllModeCharts(data) {
        const stats = {
            '已過期': data.filter(d => d.dayDiff < 0),
            '一個月內': data.filter(d => d.dayDiff >= 0 && d.dayDiff <= 30),
            '1-6 個月': data.filter(d => d.dayDiff > 30 && d.dayDiff <= 180),
            '半年至一年': data.filter(d => d.dayDiff > 180 && d.dayDiff <= 365),
            '一年以上': data.filter(d => d.dayDiff > 365),
            '日期不明': data.filter(d => d.dayDiff === null),
        };
        const labels = Object.keys(stats);
        const chartData = Object.values(stats).map(d => d.length);
        const colors = ['rgba(255, 99, 132, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(255, 205, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(153, 102, 255, 0.7)'];
        
        updateChart(pieChart, 'days-pie-chart', 'pie', labels, chartData, colors, stats, 'pie');
        updateChart(barChart, 'expiry-bar-chart', 'bar', labels, chartData, colors, stats, 'bar');
    }
    
    function updateReminderCharts(data) {
        const stats = {
            '已過期': data.filter(d => d.dayDiff < 0),
            '今天到期': data.filter(d => d.dayDiff === 0),
            '1-7 天內': data.filter(d => d.dayDiff > 0 && d.dayDiff <= 7),
            '8-30 天內': data.filter(d => d.dayDiff > 7 && d.dayDiff <= 30),
        };
        const labels = Object.keys(stats);
        const chartData = Object.values(stats).map(d => d.length);
        const colors = ['rgba(255, 99, 132, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(75, 192, 192, 0.7)'];
        
        updateChart(pieChart, 'days-pie-chart', 'pie', labels, chartData, colors, stats, 'pie');
        updateChart(barChart, 'expiry-bar-chart', 'bar', labels, chartData, colors, stats, 'bar');
    }

    function updateChart(chartInstance, canvasId, type, labels, data, colors, stats, chartIdentifier) {
        const chartCanvas = document.getElementById(canvasId).getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        const chart = new Chart(chartCanvas, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: '人數',
                    data: data,
                    backgroundColor: colors,
                    borderColor: type === 'bar' ? colors.map(c => c.replace('0.7', '1')) : '#fff',
                    borderWidth: type === 'bar' ? 1 : 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: type === 'pie' },
                    datalabels: {
                        formatter: (value) => value > 0 ? value : null,
                        color: '#fff',
                        font: {
                            weight: 'bold'
                        },
                        anchor: 'center',
                        align: 'center'
                    }
                },
                scales: type === 'bar' ? { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { stepSize: 1 } 
                    } 
                } : {},
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const clickedIndex = elements[0].index;
                        const clickedLabel = labels[clickedIndex];
                        renderTable(stats[clickedLabel]);
                        
                        if (chartIdentifier === 'pie') {
                            resetPieBtn.style.display = 'block';
                            resetBarBtn.style.display = 'none';
                        } else {
                            resetBarBtn.style.display = 'block';
                            resetPieBtn.style.display = 'none';
                        }
                    }
                }
            },
        });
        
        if (canvasId === 'days-pie-chart') pieChart = chart;
        else barChart = chart;
    }
</script>

</body>
</html>